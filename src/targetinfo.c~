/*
 ============================================================================
 Name        : targetinfo.c
 Author      : m3ghd007
 Version     :
 Copyright   : Your copyright notice
 Description : Hello World in C, Ansi-style
 ============================================================================
 */

#include <stdio.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/wait.h>
#include <net/if.h>
#include "common.h"
#include "usb_monitor.h"
#include "sock_client.h"
typedef struct n {
	char *data;
	struct n *next;
} node_t;
static char address[32] = "127.0.0.1";
static int port = 10005;
static char mac[32] = {'\0'};
void get_mac() {
	FILE *file;
	char line[256];
	file = fopen("/sys/class/net/eth0/address", "r");
	if (file <= 0) {
		printf("Error openning");
		return;
	}
	fscanf(file, "%s", line);
	strcpy(mac, line);
	fclose(file);
}

int execute_script(const char *file_path)
{
	pid_t pid = 0;
	int status = 0;
	int rv = 0;
	errno = 0;
	register unsigned int index = 0;

	while (args[index] != NULL) {
		printf("%s", args[index]);
		index++;
	}

	if (!(pid = fork())) {
		printf("pid(%d), ppid (%d)", getpid(), getppid());
		printf("Inside child, exec (%s) command", file_path);

		errno = 0;
		if (execve(file_path, NULL, NULL) == -1) {
			printf("Fail to execute command (%s)", strerror(errno));
			exit(1);
		}
	} else if (pid > 0) {
		if (waitpid(pid, &status, 0) == -1)
			printf("wait pid (%u) status (%d)", pid, status);

		if (WIFEXITED(status)) {
			rv = WEXITSTATUS(status);
			printf("exited, status=%d", rv);
		} else if (WIFSIGNALED(status)) {
			printf("killed by signal %d", WTERMSIG(status));
		} else if (WIFSTOPPED(status)) {
			printf("stopped by signal %d", WSTOPSIG(status));
		} else if (WIFCONTINUED(status)) {
			printf("continued");
		}

		return rv;
	}

	printf("failed to fork(%s)", strerror(errno));
	return -EIO;
}

node_t *get_target_info() {
	FILE *file;
	char line[256];
	char *data;
	node_t *head = NULL, *temp = NULL;

	execute_script("/usr/bin/perl", "~/get_info.pl");

	file = fopen("~/final.info", "r");
	if (file <= 0) {
		printf("Error openning");
	}
	bzero(line, sizeof(line));
	while(fscanf(file, "%s", line) > 0) {
		printf("line = %s", line);
		data = (char *)malloc(strlen(line) * sizeof(char));
		bzero(data, strlen(line) * sizeof(char));
		strcpy(data, line);
		temp = (node_t *) malloc(sizeof(node_t));
		temp->data = data;
		temp->next = head;
		head = temp;
	};
	fclose(file);
	remove("~/final.info");
	return head;
}

static void take_action(action_e act, void *data) {
	node_t *head = NULL;
	node_t *trav = NULL, *t;
	sleep(5);
	head = get_target_info();
	trav = head;
	while(trav) {
		char messge[256];
		bzero(messge, sizeof(messge));
		sprintf(messge, "%s;%s", trav->data, mac);
		printf("Sending %s\n", messge);
		client.send(address, port, messge);
		t = trav;
		trav = trav->next;
		free(t->data);
		free(t);
	}
}

int main(int argc, char *argv[]) {
	get_mac();
	//printf("%s", mac);
	if (argc == 3) {
		bzero(address, sizeof(address));
		strncpy(address, argv[1], 31 * sizeof(char));
		port = atoi(argv[2]);
	} else {
		printf("Setting server address as [%s] and port as [%d]", address, port);
	}
	usb_monitor_init(take_action, "Hi Folks");
	return EXIT_SUCCESS;
}
